<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- jQuery -->
    <script
      src="https://code.jquery.com/jquery-3.5.1.js"
      integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc="
      crossorigin="anonymous"
    ></script>

    <!-- ê³µìš©í•¨ìˆ˜ í˜¸ì¶œ -->
    <script src="/static/api.js"></script>
    
    <title>Post Detail</title>
  </head>
  <script>
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const postTime = urlParams.get('postTime');

    // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— í† í°ì´ ì €ì¥ë˜ì–´ìˆë‹¤ë©´ ë¡œê·¸ì¸ì„ í•œ ìƒíƒœì´ê³  ì•„ë‹ˆë¼ë©´ ë¡œê·¸ì¸ì„ í•˜ì§€ì•Šì€ ìƒíƒœ.
    // ë‘ ìƒíƒœë¥¼ êµ¬ë¶„í•˜ì—¬ userIdê´€ë ¨ ì‚¬ìš©ì„ ê°€ì´ë“œ í•¨
    // let userInfo;
    // if(localStorage.getItem('token')){
    //   getSelf( function (user) {
    //       userInfo = user;
    //       console.log("í•¨ìˆ˜ ì•ˆì—ì„œì˜ ìœ ì €ì¸í¬ì˜ ë‹‰ë„¤ì„!", userInfo.nickName);
    //   });
    // }

    let userInfo;
    getSelf( function (user) {
          userInfo = user;
          console.log("í•¨ìˆ˜ ì•ˆì—ì„œì˜ ìœ ì €ì¸í¬ì˜ ë‹‰ë„¤ì„!", userInfo.nickName);
      });

    $(document).ready(function () {
      detail_post();
    });

    function detail_post() {
      $('#postDetail').empty();

      $.ajax({
        type: 'GET',
        url: `/api/post/detail/${postTime}`,
        data: {},
        error: function (xhr, status, error) {
          if (status == 404) {
            alert('ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
          window.location.herf = '/main';
        },
        success: function (response) {
          let result = response['result'];
          let title = result['title'];
          let writer = result['writer'];
          let time = result['postTime'];
          let contents = result['contents'];

          let dateY = time.substr(0, 4);
          let dateM = time.substr(4, 2);
          let dateD = time.substr(6, 2);
          let dateH = time.substr(8, 2);
          let dateMi = time.substr(10, 2);
          console.log(dateY, dateM, dateD, dateH, dateMi);
          let postingDate =
            dateY + '-' + dateM + '-' + dateD + ' ' + dateH + ':' + dateMi;

          let temp_html = `<a id="title">
                                        Title : ${title}
                                    </a>
                                    <p></p>
                                    <a id="writer">
                                        Writer : ${writer}
                                    </a>
                                    <p></p>
                                    <a id="date">
                                        Date : ${postingDate}
                                    </a>
                                    <p></p>
                                    <label for="contents">
                                        Contents
                                    </label>
                                    <p></p>
                                    <textarea id="contents" style="height: 100px; width: 344px; font-size: larger;" readonly>${contents}</textarea>
                                    <p></p>
                                    <a>
                                    ---------------------------------------------------
                                    </a>`;
          $('#postDetail').append(temp_html);
        },
      });
    }

    function go_edit() {
      window.location.href = '/post/edit?postTime=' + postTime;
    }

    function commentSave() {
      // if(userInfo === undefined) {
      //   alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.");
      //   return window.location.href='/users/login'
      // }

      let postId = postTime;
      let userId = userInfo.nickName;
      console.log("ì €ì¥ê¸°ëŠ¥ì˜ ìœ ì €ì•„ì´ë””", userId);
      let contents = $('#commentTextarea').val();
      let commentTime = new Date().toString();

      $.ajax({
        type: "POST",
        url: `/api/posts/comments`,
        data: { postId, userId, contents, commentTime },
        success: function (response) {
          alert(response.successMsg);
          if (confirm("ëŒ“ê¸€ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ìƒˆë¡œê³ ì¹¨ í•˜ê² ìŠµë‹ˆë‹¤.")){
            return window.location.reload();
          } else {
            alert("ê·¸ë˜ë„ ìƒˆë¡œê³ ì¹¨ì„ í•˜ì…”ì•¼ í•©ë‹ˆë‹¤. í¥ ë©”ë¡± ğŸ˜  ")
            return window.location.reload();
          }
        },
        error: function (error) {
          if(error.responseJSON.result === "contentsValueEmpty"){
            return alert(error.responseJSON.errorMsg);
          } else if (error.responseJSON.result === "failure"){
            return alert(error.responseJSON.errorMsg);
          } 
        }
      });
    }

    function checkLogin() {
      if(userInfo === undefined) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.");
        return window.location.href='/users/login'
      }
    };

    function commentDelete() {
      const userId = $('#comment_userId').text();
      const _id = $('#comment_id').text();
      console.log(userId, _id, postTime);
      
      if(confirm("ì •ë§ë¡œ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        $.ajax({
          type: 'DELETE',
          url: '/api/posts/comments',
          data: { userId, _id, postTime },
          success: function (response) {
            if(response.result === "success"){
              return window.location.reload();
            }
          },
          error: function (error) {
            return alert(response.responseJSON.errorMsg);
          }
        });
      } else {
        return;
      }
    }

  //í† ê¸€ì„ í†µí•´ ëŒ“ê¸€ ìˆ˜ì •ì°½ì„ ë„ìš´ë‹¤
  function toggle(id1, id2) {
    let chg1 = document.getElementById(id1);
    chg1.style.display = ((chg1.style.display!='none') ? 'none' : 'block');

    let chg2 = document.getElementById(id2);
    chg2.style.display = ((chg2.style.display!='none') ? 'none' : 'block');
  }

  function commentUpdate(id) {
    let newContents = $('#comment_input'+id).val();
    let _id = id;
    console.log(newContents, _id);

    $.ajax({
      type: 'PATCH',
      url: '/api/posts/comments',
      data: {_id, newContents},
      success: function(response){
        if(response.result === "success"){
          alert(response.successMsg);
          return window.location.reload();
        }
      },
      error: function(error){
        return alert(response.responseJSON.errorMsg);
      } 
    });
  }



  </script>
  <body>
    <h1>This page is Post Detail page!</h1>
    <button onclick="window.location.href='/users/login'">ë¡œ ê·¸ ì¸</button>
    <p></p>
    <button onclick="signOut()">ë¡œ ê·¸ ì•„ ì›ƒ</button>
    <p></p>
    <button onclick="window.location.href='/main'">ì „ ì²´ ê²Œ ì‹œ ê¸€</button>
    <p></p>
    <a> --------------------------------------------------- </a>
    <p></p>
    <div id="postDetail">
      <a id="title"> Title : test title </a>
      <p></p>
      <a id="writer"> Writer : test writer </a>
      <p></p>
      <a id="date"> Date : test date </a>
      <p></p>
      <label for="contents"> Contents </label>
      <p></p>
      <textarea
        id="contents"
        style="height: 100px; width: 20%; font-size: larger"
        readonly
      ></textarea>
    </div>
    <p></p>
    <button onclick="go_edit()">ìˆ˜ ì • í•˜ ê¸°</button>
    <p></p>
    <p></p>
    <a> --------------------------------------------------- </a>
    <p></p>

    <div id="commentArea">
      <label for="commentTextarea">
        ëŒ“ ê¸€
      </label>
      <p></p>
      <textarea
        id="commentTextarea"
        style="height: 100px; width: 20.5%"
        onclick="checkLogin()"></textarea>
      <p></p>
      <button onclick="commentSave()">ëŒ“ ê¸€ ë“± ë¡</button>
    </div>
      <!-- comment.userId -->
    <div id="commentList">
      <h3>ëŒ“ê¸€</h3>
      <p></p>
      <a> --------------------------------------------------- </a>
      <% for(let comment of comments) { %>
        <p></p>
        <label>ëŒ“ê¸€ë‚´ìš©:</label>
        <p></p>
        <a style="display: block;" id="contents<%= comment._id %>"><%= comment.contents %></a>
        <p></p>
        <div id='commnetInputDiv<%= comment._id %>' style="display: none;">
          <input id="comment_input<%= comment._id %>" style="height: 20px; width: 30%;" value="<%= comment.contents %>">
          <button id="comment_inputBtn" style="height: 19pt;" onclick="commentUpdate('<%= comment._id %>')" >ì € ì¥</button>
        </div>
        <p style="height: 1px;"></p>
        <label>ì‘ì„±ì:</label>
        <p></p>
        <a id="comment_userId"><%= comment.userId %></a>
        <p style="height: 1px;"></p>
        <label>ì‘ì„± ì‹œê°„:</label>
        <p></p>
        <a id="comment_commentTime"><%= comment.commentTime %></a>
        <p></p>
        <a style="display: none;" id="comment_id"><%= comment._id %></a>
        <p style="display: none;"></p>
        <% if (nowUserId === comment.userId) { %>
        <button id="updateBtn" onclick="toggle('contents<%= comment._id %>', 'commnetInputDiv<%= comment._id %>')">ìˆ˜ ì •</button>
        <p></p>
        <button onclick="commentDelete()">ì‚­ ì œ</button>
        <p></p>
        <a> --------------------------------------------------- </a>
        <p></p>
        <% } else { %>
          <p></p>
          <a> --------------------------------------------------- </a>
          <p></p>
        <% } %>
      <% } %>
    </div>

    <p></p>
    <button onclick="window.location.href='/main'">ì²˜ ìŒ ìœ¼ ë¡œ</button>
  </body>
</html>
